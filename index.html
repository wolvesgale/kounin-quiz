<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>高卒認定 学習クイズ（サーバーレス）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: sans-serif; background:#0f172a; color:#fff; margin:0; }
    header { padding:1em; background:#1e293b; text-align:center; font-size:1.2em; }
    main { padding:1em; max-width:800px; margin:auto; }
    button,input,select,textarea { font-size:1em; margin:.3em; padding:.5em; border-radius:6px; }
    button { background:#1e40af; color:#fff; border:none; cursor:pointer; }
    button:hover { background:#2563eb; }
    .hidden { display:none; }
    .qcard { background:#1e293b; margin:1em 0; padding:1em; border-radius:8px; }
    .choices button { display:block; width:100%; margin:.3em 0; text-align:left; }
    .wrong { background:#dc2626!important; }
    .correct { background:#16a34a!important; }
    .toolbar { margin:.5em 0; }
    .light { background:#f8fafc; color:#111; }
    .light header { background:#e2e8f0; }
    .light .qcard { background:#fff; color:#111; }
  </style>
</head>
<body>
<header>高卒認定 学習クイズ（サーバーレス）</header>
<main>
  <div id="top">
    <p>Googleスプレッドシートの共有URL または CSV公開URLを入力してください。</p>
    <input id="csvurl" style="width:100%" placeholder="共有URLまたはCSV公開URL">
    <br>
    <label>(任意) データ名: <input id="dataset" value="高認v1"></label>
    <button id="loadbtn">読み込む</button>
    <hr>
    <div>
      <label>出題順序
        <select id="order">
          <option value="fixed">順番どおり</option>
          <option value="random">ランダム</option>
        </select>
      </label>
      <label>出題数 <input id="limit" type="number" value="0" min="0"> (0=全件)</label>
    </div>
    <p>共有URLでもOKです。自動で <code>/export?format=csv</code> に変換を試みます。<br>
    必要に応じて「ウェブに公開」を有効化してください。</p>
    <h3>科目を選択してください (CSVのsubject列から自動生成)</h3>
    <div id="subjects"></div>
  </div>

  <div id="quiz" class="hidden"></div>
  <div id="weak" class="hidden"></div>
</main>

<script>
// CSV読み込み関数
async function loadCSV(url) {
  if (url.includes("docs.google.com")) {
    try {
      const u = new URL(url);
      let path = u.pathname.split("/edit")[0];
      url = u.origin + path + "/export?format=csv";
    } catch(e){}
  }
  const res = await fetch(url);
  const txt = await res.text();
  return parseCSV(txt);
}

// シンプルCSVパーサ
function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  const head = lines[0].split(",");
  const data = [];
  for (let i=1;i<lines.length;i++) {
    let row = {};
    let cols = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
    if (!cols) continue;
    cols = cols.map(c=>c.replace(/^"|"$/g,"").replace(/""/g,'"'));
    head.forEach((h,j)=>{ row[h.trim()] = cols[j]||""; });
    data.push(row);
  }
  return data;
}

// 状態
let allData = [];
let currentSubject = "";
let weakKey = "weakProblems";

// ローカルストレージ
function loadWeak() {
  return JSON.parse(localStorage.getItem(weakKey)||"[]");
}
function saveWeak(arr) {
  localStorage.setItem(weakKey,JSON.stringify(arr));
}

// UI構築
function showSubjects() {
  const subs = [...new Set(allData.map(r=>r.subject))].filter(s=>s);
  const box = document.getElementById("subjects");
  box.innerHTML = "";
  subs.forEach(s=>{
    const b = document.createElement("button");
    b.textContent = s;
    b.onclick = ()=>startQuiz(s);
    box.appendChild(b);
  });
  const bw = document.createElement("button");
  bw.textContent="苦手一覧";
  bw.onclick=showWeak;
  box.appendChild(bw);
}

function startQuiz(subj) {
  currentSubject=subj;
  document.getElementById("top").classList.add("hidden");
  document.getElementById("weak").classList.add("hidden");
  document.getElementById("quiz").classList.remove("hidden");
  renderQuiz(subj);
}

function renderQuiz(subj) {
  const cont=document.getElementById("quiz");
  cont.innerHTML="";
  let qs=allData.filter(r=>!subj||r.subject===subj);
  const order=document.getElementById("order").value;
  if (order==="random") qs=qs.sort(()=>Math.random()-0.5);
  let limit=+document.getElementById("limit").value;
  if (limit>0) qs=qs.slice(0,limit);
  qs.forEach((q,i)=>{
    const card=document.createElement("div");
    card.className="qcard";
    card.innerHTML="<b>Q"+(i+1)+". "+q.question+"</b>";
    const cdiv=document.createElement("div");
    cdiv.className="choices";
    ["a","b","c","d"].forEach(ch=>{
      if (!q["choice_"+ch]) return;
      const btn=document.createElement("button");
      btn.textContent=q["choice_"+ch];
      btn.onclick=()=>{
        if (btn.textContent===q.answer||ch.toUpperCase()===q.answer) {
          btn.classList.add("correct");
        } else {
          btn.classList.add("wrong");
          let wk=loadWeak();
          wk.push(q);
          saveWeak(wk);
        }
        exp.textContent="解説: "+q.explanation;
      };
      cdiv.appendChild(btn);
    });
    card.appendChild(cdiv);
    const exp=document.createElement("div");
    exp.style.marginTop="0.5em";
    card.appendChild(exp);
    cont.appendChild(card);
  });
  const back=document.createElement("button");
  back.textContent="TOPへ戻る";
  back.onclick=()=>{
    document.getElementById("quiz").classList.add("hidden");
    document.getElementById("top").classList.remove("hidden");
  };
  cont.appendChild(back);
}

function showWeak() {
  document.getElementById("top").classList.add("hidden");
  document.getElementById("quiz").classList.add("hidden");
  document.getElementById("weak").classList.remove("hidden");
  const cont=document.getElementById("weak");
  cont.innerHTML="<h3>苦手問題一覧</h3>";
  const arr=loadWeak();
  arr.forEach((q,i)=>{
    const d=document.createElement("div");
    d.className="qcard";
    d.innerHTML="<b>"+q.subject+": "+q.question+"</b><br>答え:"+q.answer+"<br>"+q.explanation;
    cont.appendChild(d);
  });
  const back=document.createElement("button");
  back.textContent="TOPへ戻る";
  back.onclick=()=>{
    document.getElementById("weak").classList.add("hidden");
    document.getElementById("top").classList.remove("hidden");
  };
  cont.appendChild(back);
}

document.getElementById("loadbtn").onclick=async()=>{
  const url=document.getElementById("csvurl").value.trim();
  if(!url) return;
  allData=await loadCSV(url);
  showSubjects();
};
</script>
</body>
</html>
