<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>高卒認定 学習クイズ（サーバーレス）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--bg:#0f172a;--ink:#e5e7eb;--card:#111827;--muted:#94a3b8;--btn:#1e40af;--btnH:#2563eb;--ok:#16a34a;--ng:#dc2626;--lightbg:#f8fafc;--lightink:#0b1020;--lightcard:#ffffff;--lightmuted:#475569}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink); margin:0}
    header{padding:12px 16px;background:#1f2937;text-align:center;font-size:18px}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,button{font-size:16px;padding:8px 10px;border-radius:8px}
    input,select{border:1px solid #334155;background:#0b1220;color:var(--ink)}
    button{background:var(--btn);color:#fff;border:none;cursor:pointer}
    button:hover{background:var(--btnH)}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .pill{background:#0b1220;border:1px solid #334155;color:var(--ink);padding:10px;border-radius:999px;cursor:pointer;text-align:center}
    .card{background:var(--card);border:1px solid #334155;border-radius:12px;padding:12px;margin:12px 0}
    .choices button{display:block;width:100%;text-align:left;margin:6px 0;background:#0b1220;border:1px solid #334155}
    .correct{background:#0f5132!important}
    .wrong{background:#5f1414!important}
    .explain{margin-top:8px}
    .hidden{display:none}
    /* Light theme */
    body.light{background:var(--lightbg);color:var(--lightink)}
    body.light header{background:#e2e8f0;color:#0b1020}
    body.light .card{background:var(--lightcard);border-color:#cbd5e1}
    body.light input,body.light select{background:#f1f5f9;border-color:#cbd5e1;color:#0b1020}
    body.light .pill{background:#f1f5f9;border-color:#cbd5e1;color:#0b1020}
    body.light .choices button{background:#f1f5f9;border-color:#cbd5e1;color:#0b1020}
    body.light .muted{color:var(--lightmuted)}
  </style>
</head>
<body>
<header>高卒認定 学習クイズ（サーバーレス）</header>
<div class="wrap">
  <div class="row">
    <label>出題順序
      <select id="order">
        <option value="fixed">順番どおり</option>
        <option value="random">ランダム</option>
      </select>
    </label>
    <label>出題数 <input id="limit" type="number" min="0" value="0" style="width:120px"> (0=全件)</label>
    <button id="fontSm">A−</button>
    <button id="fontLg">A＋</button>
    <button id="theme">明るく/暗く</button>
    <button id="btnWeak">苦手一覧</button>
  </div>
  <p class="muted">シートは固定URLから自動読み込みします。更新はシート側で行ってください。</p>

  <div id="home" class="card">
    <div class="muted">科目を選択してください（CSVの subject 列から自動生成）</div>
    <div id="subjects" class="grid" style="margin-top:8px"></div>
  </div>

  <div id="quiz" class="hidden"></div>

  <div id="weak" class="hidden card">
    <div class="row">
      <h3 style="margin:0">苦手問題一覧</h3>
      <select id="weakFilter"><option value="">（すべての科目）</option></select>
      <button id="weakBack">TOPへ</button>
      <button id="weakClear">全削除</button>
    </div>
    <div id="weakList"></div>
  </div>
</div>

<script>
// ===== 固定CSV（自動読み込み） =====
var DEFAULT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSDR8FLvzRE3xt2vRiBPy043pDMCRJbnrmm4AEj6k4SYRQ5OSMzIjhWjeUASPMWX0I5SFK3Zl1P1pPB/pub?gid=1081595336&single=true&output=csv";

// ===== 状態 =====
var allData = [];
var settings = {order: 'fixed', limit: 0, theme: localStorage.getItem('theme')||'dark', fontScale: parseFloat(localStorage.getItem('font')||'1')};
var weakKey = 'weak:default';

// ===== ユーティリティ =====
function $(id){return document.getElementById(id)}
function setTheme(t){ document.body.classList.toggle('light', t==='light'); settings.theme=t; localStorage.setItem('theme',t); }
function setFont(scale){ scale=Math.max(0.85,Math.min(1.4,scale||1)); document.body.style.fontSize=(16*scale)+'px'; settings.fontScale=scale; localStorage.setItem('font',String(scale)); }
function shuffle(a){ for(var i=a.length-1;i>0;i--){ var j=(Math.random()*(i+1))|0; var tmp=a[i]; a[i]=a[j]; a[j]=tmp;} return a; }
function escCSV(v){ v = (v==null?'':String(v)); return '"'+v.replace(/"/g,'""')+'"'; }

// ===== CSV読込（固定URL） =====
async function loadCSV(url){
  var res = await fetch(url, {cache:'no-store'});
  if(!res.ok){ throw new Error('CSV取得エラー'); }
  var txt = await res.text();
  return parseCSV(txt);
}

// 簡易CSVパーサ（カンマ/ダブルクォート対応）
function parseCSV(text){
  var rows=[]; var i=0, cur=[], cell='', q=false; var s=text;
  while(i<s.length){ var ch=s[i];
    if(q){ if(ch==='"'){ if(s[i+1]==='"'){ cell+='"'; i+=2; continue;} q=false; i++; continue;} cell+=ch; i++; continue; }
    if(ch==='"'){ q=true; i++; continue; }
    if(ch===','){ cur.push(cell); cell=''; i++; continue; }
    if(ch==='
'){ cur.push(cell); rows.push(cur); cur=[]; cell=''; i++; continue; }
    if(ch==='
'){ i++; continue; }
    cell+=ch; i++; }
  if(cell.length||cur.length){ cur.push(cell); rows.push(cur); }
  var head = rows.shift();
  var data = rows.filter(function(r){return r.length>0 && r.some(function(x){return x!=='';});})
    .map(function(r){ var obj={}; for(var j=0;j<head.length;j++){ obj[head[j].trim()] = (r[j]||'').trim(); } return obj; });
  return data;
}

// ===== 苦手保存 =====
function loadWeak(){ try{return JSON.parse(localStorage.getItem(weakKey)||'[]');}catch(e){return [];} }
function saveWeak(list){ localStorage.setItem(weakKey, JSON.stringify(list)); }
function isSameItem(a,b){ return (a.id||'')===(b.id||'') && (a.subject||'')===(b.subject||'') && (a.question||'')===(b.question||''); }

// ===== 画面構築 =====
function renderSubjects(){
  var subs = [];
  for(var i=0;i<allData.length;i++){ var s=allData[i].subject||allData[i]['科目']||''; if(s && subs.indexOf(s)<0) subs.push(s); }
  subs.sort(function(a,b){ return a.localeCompare(b,'ja'); });
  var box = $('subjects'); box.innerHTML='';
  for(var k=0;k<subs.length;k++){ (function(sub){ var b=document.createElement('button'); b.className='pill'; b.textContent=sub; b.onclick=function(){ startQuiz(sub); }; box.appendChild(b);})(subs[k]); }
  if(subs.length===0){ var p=document.createElement('div'); p.className='muted'; p.textContent='CSVの読み込みに失敗している可能性があります。'; box.appendChild(p); }
}

function startQuiz(sub){
  $('home').classList.add('hidden'); $('weak').classList.add('hidden'); $('quiz').classList.remove('hidden');
  var list = allData.filter(function(r){ return (r.subject||r['科目']||'')===sub; })
    .map(function(r){ return {
      id: r.id||'', subject: r.subject||r['科目']||'', unit: r.unit||r['単元']||'',
      question: r.question||r['問題']||'',
      a: r.choice_a||r.A||r.choiceA||r['A']||'',
      b: r.choice_b||r.B||r.choiceB||r['B']||'',
      c: r.choice_c||r.C||r.choiceC||r['C']||'',
      d: r.choice_d||r.D||r.choiceD||r['D']||'',
      answer: (r.answer||r['正解']||'').toString().trim().toUpperCase(),
      explanation: r.explanation||r['解説']||''
    }; });
  if(settings.order==='random'){ list = shuffle(list.slice()); }
  var lim = parseInt($('limit').value||'0',10); if(!lim) lim = settings.limit||0; if(lim>0) list = list.slice(0,lim);
  renderQuizList(list, sub);
}

function renderQuizList(list, sub){
  var cont = $('quiz'); cont.innerHTML='';
  var h = document.createElement('div'); h.className='row'; h.innerHTML = '<b>'+sub+' ／ 全'+list.length+'問</b>';
  var back=document.createElement('button'); back.textContent='TOPへ'; back.onclick=function(){ $('quiz').classList.add('hidden'); $('home').classList.remove('hidden'); };
  h.appendChild(back); cont.appendChild(h);

  for(var i=0;i<list.length;i++){
    (function(idx){ var q=list[idx]; var card=document.createElement('div'); card.className='card';
      var title=document.createElement('div'); title.innerHTML='<b>Q'+(idx+1)+'. '+q.question+'</b>'; card.appendChild(title);
      if(q.unit){ var t=document.createElement('div'); t.className='muted'; t.textContent=q.unit; card.appendChild(t); }
      var chWrap=document.createElement('div'); chWrap.className='choices';
      [['A','a'],['B','b'],['C','c'],['D','d']].forEach(function(pair){ var mark=pair[0], key=pair[1]; var txt=q[key]; if(!txt) return; var btn=document.createElement('button'); btn.textContent=mark+'： '+txt; btn.onclick=function(){
          var correct = (mark===q.answer) || (txt===q.answer);
          btn.classList.add(correct?'correct':'wrong');
          if(!correct){ var wk=loadWeak(); if(!wk.some(function(x){return isSameItem(x,q);})){ wk.push(q); saveWeak(wk);} }
          exp.textContent='解説: '+q.explanation;
        }; chWrap.appendChild(btn); });
      card.appendChild(chWrap);
      var exp=document.createElement('div'); exp.className='explain muted'; card.appendChild(exp);
      cont.appendChild(card);
    })(i);
  }
}

function renderWeak(){
  var arr = loadWeak();
  var subs=[]; for(var i=0;i<arr.length;i++){ var s=arr[i].subject; if(s && subs.indexOf(s)<0) subs.push(s); }
  subs.sort(function(a,b){return a.localeCompare(b,'ja')});
  var sel=$('weakFilter'); sel.innerHTML=''; var opt=document.createElement('option'); opt.value=''; opt.textContent='（すべての科目）'; sel.appendChild(opt);
  for(var j=0;j<subs.length;j++){ var o=document.createElement('option'); o.value=subs[j]; o.textContent=subs[j]; sel.appendChild(o); }
  buildWeakList();
}

function buildWeakList(){
  var wrap=$('weakList'); wrap.innerHTML='';
  var cur=$('weakFilter').value; var arr=loadWeak(); if(cur) arr=arr.filter(function(x){return x.subject===cur});
  for(var i=0;i<arr.length;i++){
    (function(idx){ var q=arr[idx]; var d=document.createElement('div'); d.className='card';
      var s=document.createElement('div'); s.innerHTML='<b>['+q.subject+'] '+q.question+'</b>'; d.appendChild(s);
      var a=document.createElement('div'); a.textContent='答え: '+q.answer; d.appendChild(a);
      if(q.explanation){ var e=document.createElement('div'); e.textContent='解説: '+q.explanation; d.appendChild(e); }
      var rm=document.createElement('button'); rm.textContent='削除'; rm.onclick=function(){ var all=loadWeak(); all.splice(idx,1); saveWeak(all); buildWeakList(); };
      d.appendChild(rm); wrap.appendChild(d); })(i);
  }
}

// ===== 初期化 =====
$('theme').onclick=function(){ setTheme(document.body.classList.contains('light')?'dark':'light'); };
$('fontSm').onclick=function(){ setFont((settings.fontScale||1)-0.1) };
$('fontLg').onclick=function(){ setFont((settings.fontScale||1)+0.1) };
$('btnWeak').onclick=function(){ $('home').classList.add('hidden'); $('quiz').classList.add('hidden'); $('weak').classList.remove('hidden'); renderWeak(); };
$('weakBack').onclick=function(){ $('weak').classList.add('hidden'); $('home').classList.remove('hidden'); };
$('weakClear').onclick=function(){ if(confirm('苦手一覧を全削除しますか？')){ saveWeak([]); buildWeakList(); } };
$('weakFilter').onchange=buildWeakList;

window.addEventListener('DOMContentLoaded', function(){
  setTheme(settings.theme);
  setFont(settings.fontScale||1);
  $('order').value=settings.order; $('limit').value=settings.limit||0;
  loadCSV(DEFAULT_CSV).then(function(rows){ allData = rows; renderSubjects(); }).catch(function(e){ console.error(e); alert('データ読み込みに失敗しました。公開CSVのURLを確認してください。'); });
});
</script>
</body>
</html>
